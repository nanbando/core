language: php
cache:
  directories:
  - "$HOME/.composer/cache"
  - vendor
matrix:
  fast_finish: true
  include:
  - php: 7.2
    env:
    - EXECUTE_DEPLOYMENT=false
    - COMPOSER_FLAGS="--no-interaction"
  - php: 7.4
    env:
    - EXECUTE_DEPLOYMENT=true
    - COMPOSER_FLAGS="--no-interaction"
    - CODE_COVERAGE="--coverage-clover=coverage.clover"
before_install:
- if [[ -z $CODE_COVERAGE ]]; then phpenv config-rm xdebug.ini ; fi
- openssl aes-256-cbc -K $encrypted_7a05c4e35c71_key -iv $encrypted_7a05c4e35c71_iv
  -in .travis/secrets.tar.enc -out .travis/secrets.tar -d
- composer self-update
install:
- travis_retry composer update $COMPOSER_FLAGS
- composer info
script:
- ./vendor/bin/phpunit $CODE_COVERAGE
notifications:
  email: true
after_success:
- if [[ -n $CODE_COVERAGE ]]; then wget https://scrutinizer-ci.com/ocular.phar ; fi
- if [[ -n $CODE_COVERAGE ]]; then php ocular.phar code-coverage:upload --format=php-clover coverage.clover ; fi
- if [[ $EXECUTE_DEPLOYMENT == 'true' && ($TRAVIS_BRANCH == 'master' || $TRAVIS_TAG != '') && $TRAVIS_PULL_REQUEST == 'false' ]]; then rm vendor/dflydev/embedded-composer/.root_package.json ; fi
- if [[ $EXECUTE_DEPLOYMENT == 'true' && ($TRAVIS_BRANCH == 'master' || $TRAVIS_TAG != '') && $TRAVIS_PULL_REQUEST == 'false' ]]; then composer install --no-dev ; fi
- if [[ $EXECUTE_DEPLOYMENT == 'true' && ($TRAVIS_BRANCH == 'master' || $TRAVIS_TAG != '') && $TRAVIS_PULL_REQUEST == 'false' ]]; then ./bin/deploy.sh ; fi
- if [[ $EXECUTE_DEPLOYMENT == 'true' && ($TRAVIS_BRANCH == 'master' || $TRAVIS_TAG != '') && $TRAVIS_PULL_REQUEST == 'false' ]]; then ./nanbando.phar ; fi
